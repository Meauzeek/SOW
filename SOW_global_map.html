<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>《随星录》时局图 - 全球元素使分布</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans SC', sans-serif;
            overflow: hidden;
        }
        #map {
            width: 100vw;
            height: 100vh;
            background-color: #1a202c;
        }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: rgba(23, 37, 58, 0.9);
            color: #f0f9ff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(125, 211, 252, 0.3);
        }
        .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
            line-height: 1.6;
            max-height: 220px;
            overflow-y: auto;
        }
        .leaflet-popup-content h3 {
            margin: 0 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(125, 211, 252, 0.2);
            font-size: 16px;
            color: #7dd3fc;
        }
        .leaflet-popup-close-button {
            color: #f0f9ff !important;
        }
        .panel-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: flex-start;
            transition: transform 0.5s ease-in-out;
        }
        .legend-panel {
            background: rgba(14, 25, 45, 0.85);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            color: #e0f2fe;
            width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.3);
            transition: opacity 0.5s, transform 0.5s;
            transform-origin: right center;
        }
        .toggle-button {
            width: 40px;
            height: 40px;
            background: rgba(14, 25, 45, 0.85);
            border: 1px solid rgba(56, 189, 248, 0.3);
            color: #bae6fd;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: -1px;
            align-self: center;
            transition: background-color 0.3s;
        }
        .toggle-button:hover {
            background-color: rgba(56, 189, 248, 0.2);
        }
        .panel-container.collapsed .legend-panel {
            opacity: 0;
            transform: scaleX(0);
            pointer-events: none;
        }
        .panel-container.collapsed {
            transform: translateX(calc(100% - 40px));
        }
        .legend-panel h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            color: #bae6fd;
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
            padding-bottom: 10px;
        }
        .legend-section h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #7dd3fc;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .legend-item:hover {
            background-color: rgba(56, 189, 248, 0.1);
        }
        .legend-item input {
            margin-right: 10px;
        }
        .legend-item-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .legend-item-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        .custom-element-icon {
            transition: transform 0.2s ease-in-out, filter 0.2s;
        }
        .custom-element-icon:hover {
            transform: scale(1.2);
            filter: brightness(1.2);
        }
        .ancestral-home-icon .element-symbol-container {
            opacity: 0.7;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(160, 174, 192, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(160, 174, 192, 0); }
            100% { box-shadow: 0 0 0 0 rgba(160, 174, 192, 0); }
        }
        .location-icon-pulse {
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900">

    <div id="map"></div>

    <div id="panel-container" class="panel-container">
        <button id="toggle-panel-btn" class="toggle-button">&raquo;</button>
        <div class="legend-panel">
            <h2>《随星录》时局图</h2>
            <div class="legend-section">
                <h3>图例 (Markers)</h3>
                <div id="marker-legend"></div>
            </div>
            <div class="legend-section">
                <h3>阵营 (Factions)</h3>
                <div id="faction-legend"></div>
            </div>
            <div class="legend-section">
                <h3>元素使筛选 (Filters)</h3>
                <div id="filter-container"></div>
            </div>
        </div>
    </div>

    <script>
        // 1. 初始化地图
        const map = L.map('map', {
            center: [20, 30],
            zoom: 2.5,
            minZoom: 2,
            maxZoom: 18,
            worldCopyJump: true,
        });

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri & others'
        }).addTo(map);

        // 2. 定义元素使数据 (V9 - 最终修正)
        const elementUsers = [
             // 关键人物
            { name: '埃德·乔治', element: 'Ed', type: 'special', country: '中国', coords: [31.7, 112.25], faction: '观察者', color: '#FBBF24', details: '核心观察者，作者本人。原籍湖北宜城。' },
            { name: '南门巽', element: 'Ar', type: 'current', country: '中国', coords: [31.95, 118.82], faction: '南极洲立大学', color: '#8B5CF6', details: '氩(Ar)元素使，埃德的“第二自我”。现居南京江宁。' },
            { name: '南门萃', element: 'Kr', type: 'current', country: '中国', coords: [31.96, 118.83], faction: '南极洲立大学', color: '#EC4899', details: '氪(Kr)元素使，南门巽的妹妹。现居南京江宁。' },
            // 中国
            { name: '森栗 蛍', element: 'Co', type: 'current', country: '中国/日本', coords: [32.11, 118.95], faction: '南极洲立大学', color: '#63B3ED', details: '钴(Co)元素使。现居南京仙林大学城。' },
            { name: '森栗 蛍 (祖籍)', element: 'Co', type: 'ancestral', country: '日本', coords: [34.23, 135.17], faction: '南极洲立大学', color: '#63B3ED', details: '森栗蛍的祖籍地：和歌山。' },
            { name: '筑泠菀', element: 'Ni', type: 'current', country: '中国', coords: [30.54, 114.36], faction: '南极洲立大学', color: '#68D391', details: '镍(Ni)元素使。现居武汉街道口。' },
            { name: '筑泠菀 (祖籍)', element: 'Ni', type: 'ancestral', country: '中国', coords: [31.17, 112.58], faction: '南极洲立大学', color: '#68D391', details: '筑家兄妹的祖籍地：湖北荆门钟祥。' },
            { name: '筑滨辙', element: 'Zn', type: 'current', country: '中国', coords: [30.55, 114.37], faction: '独立', color: '#B794F4', details: '锌(Zn)元素使。现居武汉街道口。' },
            { name: '费羿忻', element: 'Fe', type: 'current', country: '中国', coords: [45.74, 126.63], faction: '威德尔联合工业', color: '#A0AEC0', details: '铁(Fe)元素使。哈尔滨人。' },
            { name: '新垣钺', element: 'Cu', type: 'current', country: '中国', coords: [34.85, 114.25], faction: '独立', color: '#F6AD55', details: '铜(Cu)元素使。来自古代魏国大梁（今开封西北）。' },
            { name: '蓟炳岩', element: 'B', type: 'current', country: '中国', coords: [39.12, 117.2], faction: '南极洲立大学', color: '#FBB6CE', details: '硼(B)元素使。天津人。' },
            { name: '汤聿晞', element: 'S', type: 'current', country: '中国', coords: [37.87, 112.53], faction: '南极洲立大学', color: '#F6E05E', details: '硫(S)元素使。太原人。' },
            { name: '炊雪粼', element: 'P', type: 'current', country: '中国', coords: [34.76, 113.65], faction: '南极洲立大学', color: '#F56565', details: '磷(P)元素使。郑州人。' },
            { name: '苻榭', element: 'Pb', type: 'current', country: '中国', coords: [39.63, 118.18], faction: 'LUACL', color: '#718096', details: '铅(Pb)元素使。河北唐山人。' },
            { name: '鲜宇珩', element: 'Li', type: 'current', country: '中国', coords: [19.61, 110.75], faction: '南极航空航天局', color: '#E53E3E', details: '锂(Li)元素使。海南文昌人。' },
            { name: '南宫蔚璇', element: 'Be', type: 'current', country: '中国', coords: [19.62, 110.76], faction: '南极航空航天局', color: '#4FD1C5', details: '铍(Be)元素使。海南文昌人。' },
            { name: '燕柠', element: 'Cr', type: 'current', country: '中国', coords: [31.22, 121.47], faction: '南极航空航天局', color: '#48BB78', details: '铬(Cr)元素使。现居上海。' },
            { name: '燕柠 (祖籍)', element: 'Cr', type: 'ancestral', country: '中国', coords: [29.95, 122.3], faction: '南极航空航天局', color: '#48BB78', details: '燕柠的祖籍地：浙江舟山沈家门。' },
            { name: '卢骁凌', element: 'LX', type: 'current', country: '中国', coords: [30.67, 104.06], faction: '独立', color: '#F472B6', details: '代号LX。男性。现居四川成都。' },
            { name: '公冶延', element: 'Na', type: 'current', country: '中国', coords: [34.26, 108.95], faction: '独立', color: '#f87171', details: '钠(Na)元素使。现居西安，温和耐心的师长。' },
            { name: '李明铕', element: 'Eu', type: 'current', country: '中国', coords: [25.83, 114.93], faction: '独立', color: '#d8b4fe', details: '铕(Eu)元素使。现居江西赣州。' },
            // 日本
            { name: '盐泽 汐空', element: 'Cl', type: 'current', country: '日本', coords: [40.82, 140.74], faction: '威德尔联合工业', color: '#9AE6B4', details: '氯(Cl)元素使。青森出身。' },
            { name: '竹廼门 天芥', element: 'He', type: 'current', country: '日本', coords: [35.65, 139.7], faction: '独立', color: '#FAF089', details: '氦(He)元素使。现居东京代官山。' },
            // 朝鲜
            { name: '金历研', element: 'Ti', type: 'current', country: '朝鲜', coords: [42.44, 129.75], faction: '南极航空航天局', color: '#A0AEC0', details: '钛(Ti)元素使。出身于咸镜北道会宁市。' },
            // 英国
            { name: '帕弗尼丝·埃尔芮欧', element: 'F', type: 'current', country: '英国', coords: [53.38, -2.91], faction: '南极洲立大学', color: '#4299E1', details: '氟(F)元素使。利物浦人。' },
            { name: '黛比·奥芬·特里丝卓', element: 'Te', type: 'current', country: '英国', coords: [53.39, -2.92], faction: '南极洲立大学', color: '#D53F8C', details: '碲(Te)元素使。利物浦人。' },
            { name: '阿尔西亚·埃尔芮欧', element: 'V', type: 'current', country: '英国', coords: [53.40, -2.96], faction: '南极洲立大学', color: '#ECC94B', details: '钒(V)元素使。利物浦人。' },
            { name: '阿珂由丝·西莉丝缇欧', element: 'H', type: 'current', country: '英国', coords: [53.39, -2.93], faction: '南极洲立大学/LUACL', color: '#90CDF4', details: '氢(H)元素使。利物浦人。' },
            { name: '埃尔芮欧家族 (祖籍)', element: 'F', type: 'ancestral', country: '英国', coords: [57.47, -4.22], faction: '南极洲立大学', color: '#4299E1', details: '埃尔芮欧家族的祖籍地：苏格兰，因弗内斯。' },
            { name: '艾斯克雷尔斯·埃尔芮欧', element: 'AA', type: 'current', country: '英国', coords: [51.75, -1.25], faction: '独立', color: '#e2e8f0', details: '代号AA。非元素使，帕弗尼丝的哥哥，牛津大学理论物理学者。' },
            // 法国
            { name: '玛蒂尔德·加斯蒂诺', element: 'O', type: 'current', country: '法国', coords: [48.86, 2.35], faction: '天平协定', color: '#C53030', details: '氧(O)元素使。现居巴黎。' },
            { name: '安托万·波德莱尔', element: 'Br', type: 'current', country: '法国', coords: [43.61, 3.87], faction: '天平协定', color: '#9B2C2C', details: '溴(Br)元素使。出身蒙彼利埃。' },
            { name: '纳塔尼尔·路易·卢西亚', element: 'Nu', type: 'current', country: '法国', coords: [48.8, 0.1], faction: 'LUACL', color: '#FFFFFF', details: '零号(Nu)元素使。原籍奥恩省。' },
            { name: '“艺术”(拉赫)', element: 'Tc', type: 'current', country: '法国', coords: [48.70, 2.18], faction: '泛南科学理事会', color: '#E2E8F0', details: '锝(Tc)元素使。原居奥赛。' },
            // 其他欧洲
            { name: '欧琳·洛薇特', element: 'Ne', type: 'current', country: '德国', coords: [50.93, 6.96], faction: '天平协定', color: '#FBB6CE', details: '氖(Ne)元素使。德国科隆人。' },
            { name: '卡斯帕·冯·阿斯坎尼', element: 'Xe', type: 'current', country: '奥地利', coords: [48.2, 16.37], faction: '独立', color: '#F0E68C', details: '氙(Xe)元素使。维也纳贵族。' },
            { name: '斯蒂芬妮·冯·阿斯坎尼娅', element: 'SA', type: 'current', country: '德国', coords: [48.13, 11.58], faction: '独立', color: '#fde047', details: '代号SA。非元素使，卡斯帕的堂姐，考古学博士，现居慕尼黑。' },
            { name: '弗雷德里克·克莱芬斯', element: 'Rn', type: 'current', country: '荷兰', coords: [52.37, 4.89], faction: '独立', color: '#4A5568', details: '氡(Rn)元素使。' },
            { name: '尤里·奥加涅相', element: 'Og', type: 'current', country: '俄罗斯', coords: [55.75, 37.61], faction: '独立', color: '#2D3748', details: '鿫(Og)元素使。(已牺牲)' },
            { name: '维奥莉多·赛薇亚拉', element: 'I', type: 'current', country: '西班牙', coords: [40.41, -3.7], faction: 'LUACL', color: '#805AD5', details: '碘(I)元素使。' },
            { name: '塔蒂·西尼萨玛尔', element: 'Ir', type: 'current', country: '芬兰', coords: [60.17, 24.94], faction: '独立', color: '#a5b4fc', details: '铱(Ir)元素使，拥有双重灵魂。' },
            // 美洲
            { name: '伊西多尔·柯尔克拉夫', element: 'Ga', type: 'current', country: '加拿大', coords: [46.81, -71.2], faction: '南极洲立大学', color: '#D1D5DB', details: '镓(Ga)元素使。魁北克人。' },
            { name: '塔里亚·莫斯托夫·班纳', element: 'Tl', type: 'current', country: '美国', coords: [34.05, -118.24], faction: 'LUACL', color: '#B7791F', details: '铊(Tl)元素使。加州人。' },
            { name: '于尔根·戈尔德斯坦', element: 'Au', type: 'current', country: '美国', coords: [37.77, -122.41], faction: '泛南科学理事会', color: '#FBBF24', details: '金(Au)元素使。旧金山人。' },
            { name: '尼古拉·悉米诺尔', element: 'Nd', type: 'current', country: '美国', coords: [25.76, -80.19], faction: '独立', color: '#A78BFA', details: '钕(Nd)元素使。佛罗里达迈阿密人。' },
            { name: '“老爹”', element: 'Sn', type: 'current', country: '拉普拉塔联邦', coords: [-34.92, -57.95], faction: '冰原同盟会', color: '#E2E8F0', details: '锡(Sn)元素使。拉普拉塔市人。' },
            // 非洲
            { name: '尼拉·汤恩', element: 'Nb', type: 'current', country: '埃塞俄比亚/南非', coords: [9.03, 38.74], faction: '独立', color: '#6EE7B7', details: '铌(Nb)元素使。原籍南非，后迁居埃塞俄比亚。' },
            { name: '阿利斯泰尔·克罗科', element: 'Al', type: 'current', country: '南非', coords: [-33.92, 18.42], faction: 'LUACL', color: '#94A3B8', details: '铝(Al)元素使。开普敦人。' },
            // 哈萨克斯坦
            { name: '凯撒尔·塔拉兹', element: 'Ta', type: 'current', country: '哈萨克斯坦', coords: [51.17, 71.45], faction: '威德尔联合工业', color: '#718096', details: '钽(Ta)元素使，内心保留着军人般的坚韧。现居阿斯塔纳。' },
             // Aëterna
            { name: '伍（伍昙栖）', element: 'C', type: 'current', country: 'Aëterna', coords: [22.54, 114.05], faction: '冰原同盟会', color: '#2D3748', details: '碳(C)元素使。来自爱伊忒拿，现居深圳。' },
            { name: '柒（柒涟舞）', element: 'N', type: 'current', country: 'Aëterna', coords: [22.55, 114.06], faction: '独立', color: '#A3BFFA', details: '氮(N)元素使。来自爱伊忒拿，现居深圳。' },
            { name: 'Juno (柚冬羽)', element: 'In', type: 'current', country: 'Aëterna/中国', coords: [36.07, 120.38], faction: '爱伊忒拿', color: '#9FA8DA', details: '铟(In)元素使。来自爱伊忒拿，现居青岛。' },
            { name: '玖 (玖皋)', element: '9', type: 'current', country: 'Aëterna/中国', coords: [48.58, 87.0], faction: '爱伊忒拿', color: '#FCE7F3', details: '元变量。现居新疆禾木村。' },
            { name: '拾贰 (时重壹)', element: '12', type: 'current', country: 'Aëterna/中国', coords: [29.56, 106.55], faction: '爱伊忒拿', color: '#E0E7FF', details: '实验体。现居重庆。' },
        ];

        // 3. 创建图层组、筛选器和图例
        const layers = {};
        const filterContainer = document.getElementById('filter-container');
        const factionLegendContainer = document.getElementById('faction-legend');
        const markerLegendContainer = document.getElementById('marker-legend');
        const factions = {};

        // 创建元素使标记
        elementUsers.forEach(user => {
            const { element, faction, color, type } = user;
            if (!layers[element]) {
                layers[element] = L.layerGroup().addTo(map);
            }
            if (type === 'current' || type === 'special') {
                if (!factions[faction]) {
                    factions[faction] = { color: color, count: 0 };
                }
                factions[faction].count++;
            }

            let iconHtml;
            let iconSize = (type === 'ancestral') ? [20, 20] : [24, 24];
            let iconAnchor = (type === 'ancestral') ? [10, 10] : [12, 12];
            let className = 'custom-element-icon';

            if (type === 'special') {
                iconHtml = `<div style="font-size: 24px; color: ${color}; text-shadow: 0 0 8px ${color};">★</div>`;
            } else {
                iconHtml = `<div class="element-symbol-container" style="background-color: ${color}; width: 100%; height: 100%; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 8px ${color}; display: flex; justify-content: center; align-items: center; color: #1a202c; font-weight: bold;">${element}</div>`;
                if (type === 'ancestral') {
                    className += ' ancestral-home-icon';
                }
            }
            
            const customIcon = L.divIcon({
                html: iconHtml,
                className: className,
                iconSize: iconSize,
                iconAnchor: iconAnchor
            });

            const marker = L.marker(user.coords, { icon: customIcon }).addTo(layers[element]);
            marker.bindPopup(`<h3>${user.name}</h3><b>代号:</b> ${user.element}<br><b>类型:</b> ${user.type}<br><b>原籍:</b> ${user.country}<br><b>阵营:</b> ${user.faction}<br><b>简介:</b> ${user.details}`);
        });
        
        // 添加特殊地点标记
        const specialLocations = [
            { name: '纳塔尼尔牺牲地', coords: [-35.5, 139.0], details: '<b>事件:</b> 纳塔尼尔·路易·卢西亚 (Nu) 牺牲<br><b>位置:</b> 澳大利亚，因弗墨累城 (虚构，位于墨累河口附近)<br><b>时间:</b> 2040年3月4日' },
            { name: '茹安维尔-埃斯佩兰萨自由市', coords: [-63.3, -56.4], details: '<b>地点:</b> 南极联邦核心<br><b>组成:</b> 主要由茹安维尔岛与埃斯佩兰萨站构成，是南极洲立大学及各大机构所在地。' },
            { name: '勘察加彼得罗巴甫洛夫斯克', coords: [53.02, 158.65], details: '<b>地点:</b> 俄罗斯远东<br><b>事件:</b> 2032年后日本难民的主要流向地之一，曾发生针对难民的血腥屠杀。' },
            { name: '桦太 (南萨哈林斯克)', coords: [46.96, 142.73], details: '<b>地点:</b> 库页岛南部<br><b>事件:</b> 气候剧变后的重要难民中转站，金历研与盐泽汐空曾在此短暂交汇。' },
            { name: '乌斯怀亚', coords: [-54.8, -68.3], details: '<b>地点:</b> 阿根廷火地岛<br><b>事件:</b> 世界最南端的城市，序章主角格里桑托从此偷渡前往南极。' },
            { name: '加州大学圣迭戈分校', coords: [32.88, -117.23], details: '<b>地点:</b> 美国圣迭戈<br><b>事件:</b> 筑泠菀在现实线中的留学地点。' },
            { name: '冒纳凯亚火山', coords: [19.82, -155.47], details: '<b>地点:</b> 美国夏威夷<br><b>事件:</b> 小说《脊人》的发生地。' },
            { name: '雅加达', coords: [-6.20, 106.84], details: '<b>地点:</b> 印度尼西亚<br><b>事件:</b> 气候剧变后被淹没的沿海大都市之一，小说《僰》的发生地之一。' },
            { name: '安克雷奇', coords: [61.21, -149.9], details: '<b>地点:</b> 美国阿拉斯加<br><b>事件:</b> 气候剧变后宜居性增强的近极地城市。' },
            { name: '迪蒙·迪维尔站', coords: [-66.66, 140.00], details: '<b>地点:</b> 南极洲阿黛利地<br><b>事件:</b> 澳大拉西亚联邦向该法国科考站投放中子弹，引爆澳法战争。' },
            { name: '凯尔盖朗群岛', coords: [-49.35, 69.35], details: '<b>地点:</b> 南印度洋<br><b>事件:</b> 澳法战争中的争夺焦点，后成为泛南联邦海外领地。' },
            { name: '古利特维肯', coords: [-54.28, -36.51], details: '<b>地点:</b> 南乔治亚岛<br><b>事件:</b> 南大西洋的重要战略前哨。' },
            { name: '斯坦利', coords: [-51.70, -57.85], details: '<b>地点:</b> 马尔维纳斯群岛 (福克兰群岛)<br><b>事件:</b> 拉普拉塔联邦与英美势力争夺的战略要地。' },
            { name: '拉林科纳达', coords: [-14.63, -69.45], details: '<b>地点:</b> 秘鲁安第斯山脉<br><b>事件:</b> 世界海拔最高的城市，小说《蜜人》的发生地。' }
        ];

        const locationLayer = L.layerGroup().addTo(map);
        specialLocations.forEach(loc => {
            const iconHtml = `<div class="location-icon-pulse" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;"><div style="font-size: 24px; color: #f8fafc; text-shadow: 0 0 8px #94a3b8;">⌖</div></div>`;
            const locIcon = L.divIcon({ html: iconHtml, className: 'custom-element-icon', iconSize: [24, 24], iconAnchor: [12, 12] });
            const marker = L.marker(loc.coords, { icon: locIcon }).addTo(locationLayer);
            marker.bindPopup(`<h3>${loc.name}</h3>${loc.details}`);
        });

        // 创建标记图例
        const markerTypes = [
            { type: '核心人物', html: `<div style="font-size: 24px; color: #FBBF24;">★</div>` },
            { type: '现居地', html: `<div style="background-color: #CBD5E0; width: 18px; height: 18px; border-radius: 50%; border: 2px solid #fff;"></div>` },
            { type: '祖籍', html: `<div style="background-color: #CBD5E0; width: 18px; height: 18px; border-radius: 50%; border: 2px solid #fff; opacity: 0.7; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></div>` },
            { type: '重要地点', html: `<div class="location-icon-pulse" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;"><div style="font-size: 24px; color: #f8fafc;">⌖</div></div>` }
        ];
        markerTypes.forEach(m => {
            markerLegendContainer.innerHTML += `<div class="legend-item"><div class="legend-item-icon">${m.html}</div> <span>${m.type}</span></div>`;
        });

        // 创建元素筛选器
        Object.keys(layers).sort().forEach(element => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.innerHTML = `<input type="checkbox" id="filter-${element}" checked> <label for="filter-${element}">${element}</label>`;
            filterContainer.appendChild(item);

            document.getElementById(`filter-${element}`).addEventListener('change', (e) => {
                if (e.target.checked) {
                    map.addLayer(layers[element]);
                } else {
                    map.removeLayer(layers[element]);
                }
            });
        });

        // 创建阵营图例
        Object.keys(factions).sort().forEach(faction => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            const factionData = factions[faction];
            item.innerHTML = `<div class="legend-item-icon"><div class="legend-item-color" style="background-color: ${factionData.color};"></div></div> <span>${faction} (${factionData.count})</span>`;
            factionLegendContainer.appendChild(item);
        });
        
        // 可折叠侧边栏逻辑
        const panelContainer = document.getElementById('panel-container');
        const toggleBtn = document.getElementById('toggle-panel-btn');
        toggleBtn.addEventListener('click', () => {
            panelContainer.classList.toggle('collapsed');
            if (panelContainer.classList.contains('collapsed')) {
                toggleBtn.innerHTML = '&laquo;';
            } else {
                toggleBtn.innerHTML = '&raquo;';
            }
        });

    </script>
</body>
</html>

